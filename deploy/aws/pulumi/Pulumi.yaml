name: pulumi-dapr
runtime: yaml
description: use dapr and pulumi to build a aws application
outputs:
  storeName: ${statestore.id}
  topicARN: ${snsTopic.arn}
  httpHelloFnName: ${httpHelloFn.id}
  httpStoreFnName: ${httpStoreFn.id}
  apiUrl: ${apiDeploymentStage.invokeUrl}
  # repoUrl: ${pulumiDaprHttpRepo.url}
  # imageUri: ${pulumiDaprHttpImage.imageUri}

resources:
  # pulumiDaprHttpRepo:
  #   type: awsx:ecr:Repository
  # pulumiDaprHttpImage:
  #   type: awsx:ecr:Image
  #   properties:
  #     repositoryUrl: ${pulumiDaprHttpRepo.url}
  #     path: "../../../"

  statestore:
    type: aws:dynamodb:Table
    properties:
      readCapacity: 10
      writeCapacity: 10
      hashKey: Id
      attributes:
        - name: Id
          type: S
  
  iamForLambda:
    type: aws:iam:Role
    properties:
      assumeRolePolicy: ${assumeRole.json}
  policyPolicy:
    type: aws:iam:Policy
    properties:
      description: attach writting log and accessing dynamoDB
      policy: ${policyDocument.json}
  policyAttach:
    type: aws:iam:PolicyAttachment
    properties:
      roles:
        - ${iamForLambda.name}
      policyArn: ${policyPolicy.arn}

  httpHelloFn:
    type: aws:lambda:Function
    properties:
      packageType: Image
      # imageUri: ${pulumiDaprHttpImage.imageUri}
      imageUri: 811762874732.dkr.ecr.us-east-1.amazonaws.com/pulumi-dapr:latest
      role: ${iamForLambda.arn}
      timeout: 121
      environment:
        variables:
          CIR_DIR: "/app/cir/http_hello"
    options:
      replaceOnChanges: ["environment.variables", "timeout"]
  httpHelloFnUrl:
    type: aws:lambda:FunctionUrl
    properties:
      functionName: ${httpHelloFn.arn}
      authorizationType: NONE

  httpStoreFn:
    type: aws:lambda:Function
    properties:
      packageType: Image
      # imageUri: ${pulumiDaprHttpImage.imageUri}
      imageUri: 811762874732.dkr.ecr.us-east-1.amazonaws.com/pulumi-dapr:latest
      role: ${iamForLambda.arn}
      timeout: 120
      environment:
        variables:
          CIR_DIR: "/app/cir/http_store"
    options:
      replaceOnChanges: ["environment.variables", "timeout"]
  httpStoreFnUrl:
    type: aws:lambda:FunctionUrl
    properties:
      functionName: ${httpStoreFn.arn}
      authorizationType: NONE

  subFn:
    type: aws:lambda:Function
    properties:
      packageType: Image
      # imageUri: ${pulumiDaprHttpImage.imageUri}
      imageUri: 811762874732.dkr.ecr.us-east-1.amazonaws.com/pulumi-dapr:latest
      role: ${iamForLambda.arn}
      timeout: 120
      environment:
        variables:
          CIR_DIR: /app/cir/sub
    options:
      replaceOnChanges: ["environment.variables"]

  apiGateway:
    type: aws:apigateway:RestApi
    properties:
      name: pulumi-dapr
  apiDeploymentStage:
    type: aws:apigateway:Deployment
    properties:
      restApi: ${apiGateway.id}
      stageName: "dev"
    options:
      dependsOn:
        - ${httpHelloIntegration}
        - ${httpStoreIntegration}

  httpHelloResource:
    type: aws:apigateway:Resource
    properties:
      restApi: ${apiGateway.id}
      parentId: ${apiGateway.rootResourceId}
      pathPart: 'hello'
  httpHelloMethod:
    type: aws:apigateway:Method
    properties:
      restApi: ${apiGateway.id}
      resourceId: ${httpHelloResource.id}
      httpMethod: GET
      authorization: NONE
  httpHelloIntegration:
    type: aws:apigateway:Integration
    properties:
      restApi: ${apiGateway.id}
      resourceId: ${httpHelloResource.id}
      httpMethod: ${httpHelloMethod.httpMethod}
      integrationHttpMethod: POST
      type: AWS_PROXY
      uri: ${httpHelloFn.invokeArn}
  httpHelloTrigger:
    type: aws:lambda:Permission
    properties:
      action: lambda:InvokeFunction
      function: ${httpHelloFn.name}
      principal: apigateway.amazonaws.com
      sourceArn: ${apiGateway.executionArn}/*

  httpStoreResource:
    type: aws:apigateway:Resource
    properties:
      restApi: ${apiGateway.id}
      parentId: ${apiGateway.rootResourceId}
      pathPart: 'store'
  httpStoreMethod:
    type: aws:apigateway:Method
    properties:
      restApi: ${apiGateway.id}
      resourceId: ${httpStoreResource.id}
      httpMethod: GET
      authorization: NONE
  httpStoreIntegration:
    type: aws:apigateway:Integration
    properties:
      restApi: ${apiGateway.id}
      resourceId: ${httpStoreResource.id}
      httpMethod: ${httpStoreMethod.httpMethod}
      integrationHttpMethod: POST
      type: AWS_PROXY
      uri: ${httpStoreFn.invokeArn}
  httpStoreTrigger:
    type: aws:lambda:Permission
    properties:
      action: lambda:InvokeFunction
      function: ${httpStoreFn.name}
      principal: apigateway.amazonaws.com
      sourceArn: ${apiGateway.executionArn}/*

  snsTopic:
    type: aws:sns:Topic
    properties:
      name: "access"
      tags:
        dapr-topic-name: access
  snsSubscription:
    type: aws:sns:TopicSubscription
    properties:
      endpoint: ${subFn.arn}
      protocol: lambda
      topic: ${snsTopic.arn}
  snsTrigger:
    type: aws:lambda:Permission
    properties:
      action: lambda:InvokeFunction
      function: ${subFn.name}
      principal: sns.amazonaws.com
      sourceArn: ${snsTopic.arn}

variables:
  assumeRole:
    fn::invoke:
      function: aws:iam:getPolicyDocument
      arguments:
        statements:
          - effect: Allow
            principals:
              - type: Service
                identifiers:
                  - lambda.amazonaws.com
            actions:
              - sts:AssumeRole
  policyDocument:
    fn::invoke:
      function: aws:iam:getPolicyDocument
      arguments:
        statements:
          - effect: Allow
            actions:
              - dynamodb:*
              - logs:*
              - sns:*
            resources:
              - '*'