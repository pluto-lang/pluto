# @plutolang/pyright-deducer

## 0.1.32

### Patch Changes

- Updated dependencies [dbbfde4]
  - @plutolang/base@0.4.10

## 0.1.31

### Patch Changes

- ed1918b: feat(deducer): remove build_client from generated runtime code

  Previously, the build_client was automatically included in the python runtime code generated by the deducer.

## 0.1.30

### Patch Changes

- 86cb072: feat(deducer): parse index URLs from requirements.txt

  The deducer now parses index URLs specified in the project's root requirements.txt file. These URLs are utilized for dependency installation and are also included in the generated requirements.txt file.

## 0.1.29

### Patch Changes

- 0d2f967: feat(deducer): generate the requirements with index urls
- 1a89ae8: feat(deducer): support basic unary operation

## 0.1.28

### Patch Changes

- Updated dependencies [8f0e48d]
  - @plutolang/base@0.4.9

## 0.1.27

### Patch Changes

- Updated dependencies [c8dfa7a]
  - @plutolang/base@0.4.8

## 0.1.26

### Patch Changes

- b277a26: feat(deducer): add support for custom runtime adapter

  Add functionality to handle a custom adapter in the stack configuration.

  When the 'provision type' option is set to 'Custom', users are now prompted to enter the name of their adapter package. Once supplied, it is included in the project's configuration, enabling the use of a bespoke adapter.

- Updated dependencies [b277a26]
  - @plutolang/base@0.4.7

## 0.1.25

### Patch Changes

- 3dc4015: feat(deducer): add detection of pip index URLs from pyproject.toml

  This commit introduces functionality within the deducer to identify and extract index URLs specified in the pyproject.toml file when managed by Poetry.

## 0.1.24

### Patch Changes

- Updated dependencies [4e5b0b1]
  - @plutolang/base@0.4.6

## 0.1.23

### Patch Changes

- 2afed38: feat(deducer): add custom entrypoint support for outputs

## 0.1.22

### Patch Changes

- 5f58b7c: feat(deducer): enable recursive local module imports

  Previously, the pyright deducer would only bundle modules imported in main.py. With this commit, it now recursively searches and bundles all local modules.

## 0.1.21

### Patch Changes

- a11206f: feat(deducer): enable relative imports for local modules

  Users can now perform relative imports of local modules within the app directory. The Pyright deducer has been updated to copy these modules to the root of each bundle directory for seamless integration.

## 0.1.20

### Patch Changes

- 83f5d44: feat(deducer): speed up bundling by parallelizing package installation

  By installing packages in parallel, the bundling process is accelerated.

## 0.1.19

### Patch Changes

- 88562a9: feat(deducer): add custom function support for infrastructure ops

  Implement the ability for users to define custom functions to reuse infrastructure operations. This includes constructing the function object and executing associated API calls.

  However, users are currently restricted to invoking only infrastructure API calls within the custom function. They're unable to call other functions, such as client APIs or regular functions, nor can they return values from the custom function.

## 0.1.18

### Patch Changes

- b7c9d45: feat(deducer): add option to disable dependency bundling

  Add a configuration option `bundleWithDependencies` to disable automatic bundling of dependencies in the Pyright deducer. When set to `false`, dependency bundling is turned off.

## 0.1.17

### Patch Changes

- 2afaee6: feat(deducer): support to extract the code segment for a paramter

  Enhance CodeExtractor to handle parameters by retrieving associated arguments from provided fillings. It now extracts code segments for these arguments and replaces the parameter's code segment accordingly.

- 6f75db8: refactor(base): refactor architecture reference data structure

  Refine the argument type for adding resources to capture property types, clarifying usage. Redefine the three Relationship types for improved code readability and to clarify resource relationships across various scenarios.

- 70f0e77: enhance(deducer): remove SourceFile dependency in CodeExtractor
- 26757ce: ehance(deducer): limit the type of filllings for variable evaluation
- Updated dependencies [6f75db8]
- Updated dependencies [339dcfb]
  - @plutolang/base@0.4.5

## 0.1.16

### Patch Changes

- 434e3fe: feat(deducer): replace value evaluator with new versio

  The new ValueEvaluator is designed to build an expression tree first and then evaluate it with the given parameters, enabling the support for local variable computations.

  The expression tree, referred to as ValueTree in the code, is a hierarchical structure where each node represents an expression, not including nodes like function definitions. By evaluating the expressions, we can obtain the values of the nodes. Since an expression may depend on other expressions, calculating a node's value requires recursively computing the values of the dependent nodes.

## 0.1.15

### Patch Changes

- c014d1c: fix(deducer): ensure consistent parameter order between Python and TypeScript

  The use of a named parameter list in the Python deducer code led to inconsistencies with the TypeScript IaC code parameter order. This change aligns the parameter orders across both languages to ensure consistency and avoid potential confusion or errors due to mismatched parameters.

## 0.1.14

### Patch Changes

- 4a0d854: fix(deducer): replace slash with underscore in variable names

  When a resource name contains a slash, it incorrectly appears in the variable name, violating naming conventions. This commit addresses the problem by substituting slashes with underscores in variable names. Additionally, it ensures the removal of leading slashes and digits from variable names.

## 0.1.13

### Patch Changes

- 7f2e28c: fix(deducer): fix missed extraction of environment variables for functions, lambdas, and classes

  Missed the extraction of environment variables when accessed inside the body of functions, lambdas, and classes. This fix addresses the issue by checking the dependent environment variables, during searching the outside variables used within these node types.

## 0.1.12

### Patch Changes

- 5dd7c89: feat(deducer): support more situations for resource constructor and infra api args

  This update enhances the deducer module by allowing environment variables and variables to be passed to resource constructors and infra API arguments. Specifically, it now supports:

  - Direct literal values (e.g., `1`, `true`, `"hello"`).
  - Direct dataclass constructors (e.g., `Model(name="hello")` where `Model` is a dataclass).
  - Direct access to environment variables (e.g., `os.environ["key"]`, `os.environ.get("key", "default")`).
  - Variables (e.g., `var1`, `var2`), with the requirement that they are defined exactly once and assigned with the supported value types.
  - Tuples or dicts containing the supported types of values.

- 87f35b5: feat: enable runtime access to locally defined env vars

  Previously, environment variables were only accessible through the resource constructor and infrastructure APIs. This commit enables client APIs to access these variables.

  During function argument extraction by the deducer from the resource constructor or infrastructure APIs, all accessed environment variables within the compute closure are recorded. These variables are then passed to the architecture reference. Subsequently, the generator declares these environment variables for each closure variable in the IaC code. When the adapter runs the IaC code, it sets up the environment variables for the built function instance, such as AWS Lambda instances. The procedure of setting up these environment variables is written in the infrastructure SDK.

- Updated dependencies [87f35b5]
  - @plutolang/base@0.4.4

## 0.1.11

### Patch Changes

- b3400ad: feat(deducer): allow using direct captured properties as arguments in infra API

  This change introduces the ability to use direct captured properties as arguments in infrastructure API calls. For instance, the code below is now considered valid:

  ```python
  from pluto_client import Website, Router

  router = Router("router")
  website = Website(path="path/to/website", name="website")

  website.addEnv("ROUTER", router.url())
  ```

  In this example, `router.url()` is a direct captured property which the website utilizes to establish a connection to the backend service.

  The goal is for the infrastructure API to accept both direct captured properties and variables assigned with these properties, as demonstrated here:

  ```python
  from pluto_client import Website, Router

  router = Router("router")
  website = Website(path="path/to/website", name="website")

  router_url = router.url()
  website.addEnv("ROUTER", router_url)
  ```

  Currently, the API only accepts direct captured properties as arguments. Future updates will include support for variables that store the return values of these properties.

## 0.1.10

### Patch Changes

- e9a1551: fix: skip dependency installation even if the last install failed

  Previously, the installation process overlooked the `done` flag in the metadata, causing it to skip installing dependencies even if the last attempt failed, as long as the dependencies were the same as those previously identified.

- 8db533e: feat(deducer): dynamically obtain resource type FQN from class definition

  Previously, the process of obtaining the fully qualified name (FQN) of a resource type was based on a hard-coded package name during deducing. This approach has been updated to leverage a `fqn` member variable present within the resource type class definition itself, thus avoiding the need for hard-coding.

- 58e6359: feat(deducer): fix the name of extracted bundle

  Previously, the name of the extracted bundle was determined by the entrypoint's position in the source code, leading to frequent changes and unnecessary reinstallation of dependent packages. This process was both time-consuming and network-intensive. Now, the naming convention relies on the associated resource's name, method name, and the name and index of the parameter corresponding to the bundle's entrypoint, enhancing stability.

## 0.1.9

### Patch Changes

- 023e0e2: feat(deducer): support the intrinsic declaration type during Python code extraction

  This change introduces support for intrinsic declaration types such as `__name__` and `__file__` during the Python code extraction process.

## 0.1.8

### Patch Changes

- bc6b168: feat(deducer): support extracting format string in Python

  Previously, when the pyright deducer encountered a StringList node, it would only extract the string directly. However, for format strings that depend on variables, this approach was insufficient. This update allows the deducer to extract both the format string and its associated variables from the node.

- a232931: fix(deducer): fix package installation with mismatched module names

  Previously, the pyright deducer used the imported module name for package installation, causing failures for modules like `faiss`, which is imported as `faiss` but the package name is `faiss-cpu`.

  Now, it will search all dist-info directories, constructing package information from metadata and top-level.txt files. This establishes the relationship between installed package names and imported module names, resolving the installation issue.

- Updated dependencies [0a01098]
  - @plutolang/base@0.4.3

## 0.1.7

### Patch Changes

- 4d74eb6: fix(deducer): correct exportName setting for multiline export statements

  This commit addresses an issue where errors occur when setting the exportName for export statements that contain line breaks. The issue arises particularly when the export statement is a function call, lambda expression, or similar, and spans multiple lines.

  Previously, the strategy was to assign the last line of the statement to the exportName, which proved to be incorrect for multiline statements. This commit changes that approach to assign the entire statement to the exportName, if the statement spans multiple lines.

  Consider the following function call, where the second argument is the statement we want to export:

  ```python
  router.all("/*", lambda *args, **kwargs: Mangum(return_fastapi_app(),
                                                  api_gateway_base_path="/dev")(*args, **kwargs), raw=True)
  ```

  Before this fix, the assignment would look like this:

  ```python
  lambda *args, **kwargs: Mangum(return_fastapi_app(),
  exportName                                                api_gateway_base_path="/dev")(*args, **kwargs)
  ```

  After this fix, the assignment is as follows:

  ```python
  exportName = lambda *args, **kwargs: Mangum(return_fastapi_app(),
                                                  api_gateway_base_path="/dev")(*args, **kwargs)
  ```

## 0.1.6

### Patch Changes

- bfded23: feat(deducer): expand support for python runtimes

  Recognizing that the Python runtime on a developer's device may not always be 'python3.10', we have extended our support to include a broader range of Python runtimes. The updated requirements now stipulate that the Python runtime should be 'python3.8' or higher, but not exceeding 'python3.12'.

## 0.1.5

### Patch Changes

- f77412f: fix(deducer): refactor code extraction to handle resource object creation

## 0.1.4

### Patch Changes

- f4b7b8e: feat(deducer): support extracting dependent code from binary operations and list comprehensions

  Binary operations and list comprehensions are common in Python code. LangChain uses binary operations as its LCEL. Therefore, it's important to support extracting the dependent code from binary operations and list comprehensions.

  The process of extracting binary operations and list comprehensions is similar to extracting other nodes. It involves recursively extracting child expressions, using the source code as the extracted code, and adding the dependent declarations of the child expressions to the extraction result.

  There's another small tweak in the code. We've added the `uselessFilesPatterns` option to the `bundleModules` function, enabling to define which file patterns to delete during module bundling. By default, `.pyc`, `__pycache__`, and `dist-info` files will be deleted. However, LangChain requires the `pydantic` metadata files within the `dist-info` directory. Therefore, we now specify the `uselessFilesPatterns` option for `.pyc` and `__pycache__` only.

## 0.1.3

### Patch Changes

- Updated dependencies [8819258]
  - @plutolang/base@0.4.2

## 0.1.2

### Patch Changes

- 5f3abe1: fix(deducer): failed to bundle the dependencies of pyright-internal when publishing pyright-deducer

  Before, we used the `bundleDependencies` option to bundle the dependencies of `pyright-internal` when publishing `pyright-deducer`. However, it failed to include the dependencies of `pyright-internal` when publishing `pyright-deducer`. So, we opted to utilize webpack to bundle the entire `pyright-deducer` package along with all its dependencies, including `pyright-internal` and its dependencies.

  Because webpack bundles each dependency of `pyright-deducer` into a single file, if we attempt to verify whether an instance of PyrightDeducer from `pyright-deducer` is an instance of Deducer from `@plutolang/base`, we will receive a false result. Therefore, we should check for the existence of the `deduce` method instead.

## 0.1.1

### Patch Changes

- 1ca8e3c: feat: using `pip install` to bundle dependencies instead of copying local packages

  When creating the Lambda deployment package, it's essential to bundle dependencies. Previously, we built the dependency graph for a single closure, identified the directories containing the dependent packages, and copied them into the deployment package. However, this approach struggles with cross-architecture deployment and may include unnecessary files.

  Now, we utilize `pip install` to install directly dependent packages for a closure. If the target runtime or architecture differs from the local environment, we employ Docker to handle dependency installation before packaging. While this method offers greater reliability, it's slower compared to the previous approach.

- Updated dependencies [2a0a874]
  - @plutolang/base@0.4.1

## 0.1.0

### Minor Changes

- 1c3c5fa: feat: python support, validated with quickstart

  We created a deducer using Pyright. It can automatically analyze the dependent packages for each section of business logic, and the adapter includes them in the zip archive for publishing on AWS Lambda.

  Currently, Pluto supports simple Python projects. Users can use the pluto command to create and deploy Python projects. However, if the project relies on packages with different distribution packages on various platforms, or if the archive size after zipping exceeds the AWS limit of 50 MB, it will fail.

  For more details, you can find in the PRs related to the issue https://github.com/pluto-lang/pluto/issues/146 .

### Patch Changes

- 11ecc36: feat: support python workflow
- Updated dependencies [1c3c5fa]
- Updated dependencies [11ecc36]
  - @plutolang/base@0.4.0
